"use client";

import React, { useMemo, useState, useEffect } from "react";
import { Search, BookOpen, ChevronRight, Sun, Moon } from "lucide-react";
import CodeBlock from "@/components/CodeBlock";
import Link from "next/link"; // ← 在文件最上方加上这个
import Image from "next/image";


/** ---------- 内容数据类型 ---------- */
type PNode = { type: "p"; text: string };
type CodeNode = { type: "code"; code: string; lang?: string; filename?: string };
type ListNode = { type: "ul"; items: string[] };

/** ✅ 新增：图片节点 */
type ImgNode = {
  type: "img";
  src: string;         // 例如: "/images/system-collaboration-webit.png"
  alt: string;         // 无障碍/SEO
  caption?: string;    // 说明文字（可选）
  width?: number;      // 用 next/image 时推荐
  height?: number;     // 用 next/image 时推荐
};
/** ---------- 内容数据类型 ---------- */
type ContentNode = PNode | CodeNode | ListNode | ImgNode;

type Lesson = {
  id: string;
  title: string;
  summary?: string;
  content: ContentNode[];
  level?: "basic" | "intermediate" | "advanced";
  estMin?: number;
};

type Chapter = {
  key: string;
  title: string;
  lessons: Lesson[];
};

/** ---------- 示例课程大纲 ---------- */
const CURRICULUM: Chapter[] = [
  {
    "key": "world-wide-web",
    "title": "World Wide Web（ウェブの基礎構造）",
    "lessons": [
      {
        "id": "hypertext",
        "title": "ハイパーテキスト",
        "summary": "文書同士をリンクでつなぎ、非線形に情報へアクセスできる仕組み。",
        "content": [
          {
            "type": "p",
            "text": "ハイパーテキストとは、文書同士を相互にリンクさせ、利用者が自由な順序で情報を辿れるようにした仕組みです。テキストの一部をクリックすると別の文書へジャンプできる構造を持ち、Webの基盤となっています。"
          },
          {
            "type": "p",
            "text": "ハイパーテキストの概念自体はWeb誕生以前から存在しましたが、HTMLとHTTPの登場により、世界中の文書をネットワークで結びつける形へと発展しました。"
          },
          {
            "type": "ul",
            "items": [
              "テキスト内で別ページへジャンプできる仕組み",
              "線形ではなく“ネットワーク構造”の情報体系をつくる",
              "HTMLの<a>タグによるリンクが代表例",
              "Webの核心概念であり「情報をつなぐ構造」を実現"
            ]
          }
        ]
      },
      {
        "id": "protocol",
        "title": "プロトコル",
        "summary": "コンピュータ間でデータをやり取りするための“通信ルール”。",
        "content": [
          {
            "type": "p",
            "text": "プロトコルとは、コンピュータ同士がネットワーク上でデータを送受信するための“共通ルール”です。人間が同じ言語で会話するのと同じく、通信にも統一されたルールが必要になります。"
          },
          {
            "type": "p",
            "text": "Web の世界では、特に HTTP（HyperText Transfer Protocol）が中心的な役割を担い、WebブラウザとWebサーバが文書や画像データを送受信する際に利用されます。"
          },
          {
            "type": "ul",
            "items": [
              "通信に必要な取り決め（ルールや形式）",
              "代表例：HTTP / HTTPS / TCP / IP",
              "クライアントとサーバが同一ルールの下で通信する",
              "Webアプリケーションの基盤として不可欠"
            ]
          }
        ]
      },
      {
        "id": "url",
        "title": "URL",
        "summary": "インターネット上の“住所”として資源の位置を示す仕組み。",
        "content": [
          {
            "type": "p",
            "text": "URL（Uniform Resource Locator）は、Web上のあらゆる資源（HTML、画像、APIなど）がどこに存在するかを示す“住所”の役割を持ちます。ブラウザはURLを手掛かりに目的のサーバへアクセスします。"
          },
          {
            "type": "p",
            "text": "URLは、プロトコル・ドメイン名・パス・クエリパラメータなどの要素で構成されており、資源の取得方法と場所を一意に指定できます。"
          },
          {
            "type": "ul",
            "items": [
              "例：https://example.com/users/123?sort=desc",
              "プロトコル（例: https）",
              "ホスト名（例: example.com）",
              "パス（例: /users/123）",
              "クエリ（例: sort=desc）"
            ]
          }
        ]
      },
      {
        "id": "web-server-and-client",
        "title": "WebサーバとWebクライアント",
        "summary": "ブラウザとサーバがHTTPを介してデータをやり取りする構造。",
        "content": [
          {
            "type": "p",
            "text": "Webクライアントは主にブラウザのことで、利用者が要求（リクエスト）を送る側です。一方、Webサーバはその要求に応じてデータ（レスポンス）を返す側です。両者はHTTPというプロトコルを介して通信します。"
          },
          {
            "type": "p",
            "text": "ユーザーがブラウザでURLを入力すると、ブラウザがWebサーバへリクエストを送り、サーバがHTMLやJSONなどのデータを返します。この一連の流れがWebアプリケーションの基本動作となります。"
          },
          {
            "type": "ul",
            "items": [
              "Webクライアント：ブラウザ、アプリ、HTTPクライアント",
              "Webサーバ：Apache, Nginx, Node.js, Rails, FastAPI など",
              "クライアント → リクエスト送信（GET / POST 等）",
              "サーバ → データ返却（HTML / JSON / 画像 など）",
              "HTTPによる双方向のやり取りがWebの基盤"
            ]
          }
        ]
      }
    ]
  },
  {
    "key": "http",
    "title": "HTTP（Web通信の基本プロトコル）",
    "lessons": [
      {
        "id": "http-request",
        "title": "HTTPリクエスト",
        "summary": "クライアントがサーバへ送る“要求メッセージ”で、Web通信の出発点となる。",
        "content": [
          {
            "type": "p",
            "text": "HTTPリクエストとは、Webクライアント（主にブラウザ）がWebサーバに対して送信する“要求メッセージ”です。ユーザーがURLを入力したり、ボタンを押したり、APIを呼び出したりする際に必ず送られます。"
          },
          {
            "type": "p",
            "text": "リクエストは主に「メソッド」「URL」「ヘッダ」「ボディ」から構成され、サーバに対してどの資源をどのように処理してほしいかを伝えます。"
          },
          {
            "type": "ul",
            "items": [
              "代表的なHTTPメソッド：GET（取得）、POST（送信）、PUT（更新）、DELETE（削除）",
              "リクエスト URL：どの資源にアクセスするか",
              "ヘッダ：User-Agent、Accept、Authorization など各種情報",
              "ボディ：POST/PUT 時の送信データ（JSON など）"
            ]
          }
        ]
      },
      {
        "id": "http-response",
        "title": "HTTPレスポンス",
        "summary": "サーバがクライアントへ返す“応答メッセージ”で、処理結果を知らせる。",
        "content": [
          {
            "type": "p",
            "text": "HTTPレスポンスは、Webサーバがクライアントからのリクエストに対して返す“応答メッセージ”です。リクエストの処理結果やデータを返す役割を持ちます。"
          },
          {
            "type": "p",
            "text": "レスポンスは主に「ステータスコード」「ヘッダ」「ボディ」から構成されます。ステータスコードは処理成功・失敗の状況を示し、ボディにはHTMLやJSONなどの実際のデータが含まれます。"
          },
          {
            "type": "ul",
            "items": [
              "ステータスコードの例：200 OK、404 Not Found、500 Internal Server Error",
              "レスポンスヘッダ：Content-Type, Set-Cookie, Cache-Control",
              "ボディ：HTML、JSON、画像データなど",
              "API開発では JSON レスポンスが主流"
            ]
          }
        ]
      },
      {
        "id": "http-characteristics",
        "title": "HTTPの特徴（ステートレス、セキュリティ）",
        "summary": "HTTPは“ステートレス”であり、通信は個別に扱われるため追加技術で状態管理が必要になる。",
        "content": [
          {
            "type": "p",
            "text": "HTTPの最も重要な特徴のひとつが“ステートレス”であることです。ステートレスとは、サーバがクライアントの状態（ログイン状況や前回の操作など）を保持しないという性質を指します。各リクエストは完全に独立しており、前後の文脈を考慮しません。"
          },
          {
            "type": "p",
            "text": "そのため、ログイン機能やカート機能など“継続的な状態管理”では Cookie、Session、JWT などの仕組みが利用されます。また、通信を安全にするためには HTTPS により暗号化する必要があります。"
          },
          {
            "type": "ul",
            "items": [
              "ステートレス：各リクエストは独立して処理される",
              "状態管理は Cookie / Session / JWT などで補完",
              "HTTP自体は暗号化されていない（平文）",
              "HTTPS により暗号化（TLS/SSL）し安全性を確保",
              "セキュリティ上の脅威：盗聴、改ざん、中間者攻撃（MITM攻撃）など"
            ]
          }
        ]
      }
    ]
  },
  {
    "key": "http-status-codes",
    "title": "HTTPステータスコード（Web通信の結果を示すコード）",
    "lessons": [
      {
        "id": "status-code-1xx",
        "title": "1xx：情報レスポンス",
        "summary": "処理が継続中であることを示す仮のレスポンス。",
        "content": [
          {
            "type": "p",
            "text": "1xx（情報レスポンス）は、クライアントのリクエストは受け取られ、処理が継続中であることを示す応答です。通常の Web ブラウザではほとんど表示されませんが、プロトコルレベルで重要です。"
          },
          {
            "type": "ul",
            "items": [
              "100 Continue：リクエストを継続して送信してよい",
              "101 Switching Protocols：サーバがプロトコル切替に同意",
              "102 Processing（WebDAV）：処理中であることを示す",
              "103 Early Hints：最終レスポンス前にヘッダを先行送信（例：リソースのプリロード）"
            ]
          }
        ]
      },
      {
        "id": "status-code-2xx",
        "title": "2xx：成功レスポンス",
        "summary": "リクエストが正常に処理されたことを示す成功コード。",
        "content": [
          {
            "type": "p",
            "text": "2xxは、クライアントのリクエストが正常に処理されたことを表すレスポンスです。WebアプリケーションやAPIで最も頻出するステータス群です。"
          },
          {
            "type": "ul",
            "items": [
              "200 OK：要求成功。HTML/JSONを返す代表的コード",
              "201 Created：新規リソースが作成された（POSTで多い）",
              "202 Accepted：処理を受理したが、まだ完了していない",
              "203 Non-Authoritative Information：変換された情報を返却",
              "204 No Content：正常だが返すデータなし（削除時など）",
              "205 Reset Content：クライアントに画面リセットを指示",
              "206 Partial Content：部分的なデータ（Rangeリクエスト）"
            ]
          }
        ]
      },
      {
        "id": "status-code-3xx",
        "title": "3xx：リダイレクト",
        "summary": "クライアントに別のURLへ移動するよう指示するレスポンス。",
        "content": [
          {
            "type": "p",
            "text": "3xxは、クライアントに“別の場所へ移動せよ”と伝えるコードです。Webブラウザでは自動的に次のURLへ移動する場合が多いです。"
          },
          {
            "type": "ul",
            "items": [
              "300 Multiple Choices：複数の候補が存在",
              "301 Moved Permanently：恒久的な移動（SEO的に重要）",
              "302 Found：一時的リダイレクト",
              "303 See Other：別のURLをGETで取得せよ",
              "304 Not Modified：キャッシュを使用せよ",
              "307 Temporary Redirect：メソッドを保持したまま一時移動",
              "308 Permanent Redirect：メソッドを保持した恒久移動"
            ]
          }
        ]
      },
      {
        "id": "status-code-4xx",
        "title": "4xx：クライアントエラー",
        "summary": "クライアント側の誤りによって処理できなかった状態を示す。",
        "content": [
          {
            "type": "p",
            "text": "4xxは、リクエスト内容に誤りがあるなど、クライアント側の原因で処理できない場合に送られるステータスコードです。API開発で頻繁に利用されます。"
          },
          {
            "type": "ul",
            "items": [
              "400 Bad Request：リクエスト不正（形式・パラメータ誤り）",
              "401 Unauthorized：認証が必要（ログインしていない）",
              "402 Payment Required：将来の使用を想定した予約コード",
              "403 Forbidden：アクセス拒否（権限不足）",
              "404 Not Found：該当リソースが存在しない",
              "405 Method Not Allowed：メソッドが使えない",
              "406 Not Acceptable：要求形式に応じたデータが返せない",
              "408 Request Timeout：リクエストが時間切れ",
              "409 Conflict：競合状態（例：データのバージョン衝突）",
              "410 Gone：リソースが完全に削除されている",
              "411 Length Required：Content-Length が必要",
              "413 Payload Too Large：送信データが大きすぎる",
              "414 URI Too Long：URLが長すぎる",
              "415 Unsupported Media Type：サポートされないデータ形式",
              "429 Too Many Requests：リクエスト過多（Rate Limit）"
            ]
          }
        ]
      },
      {
        "id": "status-code-5xx",
        "title": "5xx：サーバエラー",
        "summary": "サーバ側の問題によりリクエストを処理できなかった状態。",
        "content": [
          {
            "type": "p",
            "text": "5xxはサーバ側でエラーが発生した際に返されるステータスです。サーバ内部の不具合、処理失敗、過負荷などを表します。"
          },
          {
            "type": "ul",
            "items": [
              "500 Internal Server Error：一般的なサーバ内部エラー",
              "501 Not Implemented：機能が未実装",
              "502 Bad Gateway：上流サーバから不正な応答",
              "503 Service Unavailable：サーバ過負荷・メンテ中",
              "504 Gateway Timeout：上流サーバの応答がタイムアウト",
              "505 HTTP Version Not Supported：HTTPバージョン非対応",
              "507 Insufficient Storage（WebDAV）：ストレージ不足",
              "508 Loop Detected：ループ検出"
            ]
          }
        ]
      }
    ]
  },
  {
    "key": "internet",
    "title": "インターネット",
    "lessons": [
      {
        "id": "internet-characteristics",
        "title": "インターネットの特徴",
        "summary": "インターネットは自律分散型で、標準プロトコル（TCP/IP）とISPによって世界規模の通信を実現している。",
        "content": [
          {
            "type": "p",
            "text": "インターネットは、世界中のネットワークが相互に接続されて構成されている巨大な通信網です。特定の管理者によって中央集権的に支配されているわけではなく、多数の組織・国・企業が独立したネットワークを運営しながら相互接続しています。"
          },
          {
            "type": "p",
            "text": "その基盤を支えているのがTCP/IPを中心とした標準プロトコル群であり、異なる機器やネットワーク同士でも同じルールに従って通信できるようになっています。さらに、インターネットサービスプロバイダ（ISP）が一般ユーザーをインターネットに接続する役割を担っています。"
          },
          {
            "type": "ul",
            "items": [
              "自律分散型：世界中のネットワークが独立して管理され、中央の管理者が存在しない",
              "標準プロトコル（TCP/IP）：異なる機器同士が通信できる共通ルール",
              "インターネットサービスプロバイダ（ISP）：個人・企業をインターネットに接続する事業者"
            ]
          },
          {
            "type": "p",
            "text": "以下では、それぞれの要素について詳しく説明します。"
          }
        ]
      },
      {
        "id": "autonomous-distributed",
        "title": "自律分散型",
        "summary": "インターネットは単一の管理者が存在しない“分散型ネットワーク”。",
        "content": [
          {
            "type": "p",
            "text": "インターネットは自律分散型ネットワークと呼ばれます。これは、世界中のネットワークがそれぞれ独立（自律）して運営されながら、相互に接続（分散）されているという意味です。"
          },
          {
            "type": "p",
            "text": "そのため、どこか1カ所が停止してもインターネット全体が止まることはなく、冗長性と強い耐障害性を持っています。"
          },
          {
            "type": "ul",
            "items": [
              "各ネットワークは独立して管理されている",
              "特定の中央機関に依存しない",
              "障害に強く、大規模な停止が起きにくい"
            ]
          }
        ]
      },
      {
        "id": "tcp-ip",
        "title": "標準プロトコル（TCP/IP）",
        "summary": "インターネット通信を成立させる共通ルールであり、あらゆる機器がTCP/IPで接続される。",
        "content": [
          {
            "type": "p",
            "text": "TCP/IP（Transmission Control Protocol / Internet Protocol）は、インターネットで最も基本となる標準プロトコルです。IPが“どこへ送るか”、TCPが“確実に届けるための制御”を担当しています。"
          },
          {
            "type": "p",
            "text": "PC、スマートフォン、サーバー、クラウドなど、世界中の機器はすべてTCP/IPを使って通信しており、この共通ルールによってグローバルな接続が可能になります。"
          },
          {
            "type": "ul",
            "items": [
              "IP：宛先（アドレス）に基づいてパケットを届けるネットワーク層の役割",
              "TCP：通信を確実に届けるための“再送・確認応答”などを行う",
              "UDP：高速性を重視した通信（映像配信、オンラインゲームなど）"
            ]
          }
        ]
      },
      {
        "id": "isp",
        "title": "インターネットサービスプロバイダ（ISP）",
        "summary": "利用者をインターネットに接続する役割を担う事業者。",
        "content": [
          {
            "type": "p",
            "text": "インターネットサービスプロバイダ（ISP）は、利用者（個人・企業）をインターネットへ接続する役割を持つ事業者です。家庭のインターネット回線や企業のネットワークは通常ISPを通してインターネットと接続されています。"
          },
          {
            "type": "ul",
            "items": [
              "代表例：NTT、KDDI、SoftBank、OCN など",
              "ユーザーはISP経由でインターネットに接続",
              "ISP同士も相互接続されバックボーンを形成"
            ]
          }
        ]
      },
      {
        "id": "lan-wan",
        "title": "LANとWAN",
        "summary": "LANとWANの違い、およびネットワーク構造の基本要素を理解する。",
        "content": [
          {
            "type": "p",
            "text": "LAN（Local Area Network）は建物・家庭・オフィスなど“狭い範囲”のネットワーク、WAN（Wide Area Network）は都市・国・世界といった“広い範囲”のネットワークです。インターネットは多数のWANが相互接続された巨大なネットワークといえます。"
          },
          {
            "type": "ul",
            "items": [
              "LAN：家庭内、会社内、学校内などの小規模ネットワーク",
              "WAN：ISPや企業間を結ぶ広域ネットワーク",
              "インターネットは最大規模のWAN"
            ]
          }
        ]
      },
      {
        "id": "lan-topology",
        "title": "LANのトポロジー",
        "summary": "LAN内の機器のつながり方（接続構造）を表す概念。",
        "content": [
          {
            "type": "p",
            "text": "トポロジーとは、ネットワーク内の機器がどのように接続されているかを表す構造のことです。LANにはさまざまなトポロジーがありますが、現在はスター型が主流です。"
          },
          {
            "type": "ul",
            "items": [
              "スター型：中心のハブ・スイッチに各機器が接続（最も一般的）",
              "バス型：1本のケーブルに複数機器を接続",
              "リング型：機器が輪状に接続される方式"
            ]
          }
        ]
      },
      {
        "id": "backbone",
        "title": "バックボーン",
        "summary": "広域ネットワークやインターネットを支える“大動脈”となる高速回線。",
        "content": [
          {
            "type": "p",
            "text": "バックボーンとは、インターネットを構成する重要なネットワーク間をつなぐ非常に高速・大容量の通信回線のことです。ISP同士もバックボーンを介して相互接続され、世界規模の通信が成り立っています。"
          },
          {
            "type": "ul",
            "items": [
              "大規模データセンター間を結ぶ高速回線",
              "ISP同士を結ぶ基幹ネットワーク",
              "海底ケーブルや衛星通信もバックボーンの一部"
            ]
          }
        ]
      },
      {
        "id": "public-circuit",
        "title": "公衆回線",
        "summary": "一般ユーザーが利用できる通信回線で、ISPを通じてインターネットへ接続される。",
        "content": [
          {
            "type": "p",
            "text": "公衆回線とは、一般ユーザーや企業が利用できる通信回線のことです。家庭の光回線、モバイル通信（4G/5G）、ADSL などがこれに該当し、ISPが提供する回線を利用してインターネットに接続します。"
          },
          {
            "type": "ul",
            "items": [
              "光回線（FTTH）",
              "モバイル通信（4G/5G）",
              "CATVインターネット",
              "公衆無線LAN（Wi-Fiスポット）"
            ]
          }
        ]
      },
      {
        "id": "routing",
        "title": "ルーティング",
        "summary": "ネットワーク間でパケットを最適な経路へ導く技術。",
        "content": [
          {
            "type": "p",
            "text": "ルーティングとは、データ（パケット）を目的地まで届けるために、ネットワーク経路を選択する仕組みのことです。ルータが宛先IPアドレスを読み取り、適切なネットワークへ転送します。"
          },
          {
            "type": "p",
            "text": "インターネットは世界中のネットワークが複雑に接続されているため、ルーティングは“最適な経路の選択”を継続的に行いながら通信を成立させています。"
          },
          {
            "type": "ul",
            "items": [
              "ルータがパケットの経路を選択・転送する",
              "最短経路だけでなく、障害時の経路変更も自動で行う",
              "代表的なルーティングプロトコル：BGP、OSPF、RIP"
            ]
          }
        ]
      }
    ]
  },
  {
    "key": "network-connection-types",
    "title": "インターネット接続とWebアプリケーション",
    "lessons": [
      {
        "id": "webapp-connection",
        "title": "Webアプリケーションと接続形態",
        "summary": "Webアプリケーションを利用するための接続形態（固定・可変IP、モバイル、ブロードバンドなど）を理解する。",
        "content": [
          {
            "type": "p",
            "text": "Webアプリケーションを利用する際、ユーザーデバイスは必ず何らかのネットワーク接続を通じてインターネットにアクセスします。接続方式には、固定回線、モバイル通信、公衆Wi-Fiなど複数の形態が存在し、それぞれの特性は通信速度、安定性、セキュリティに影響を与えます。"
          },
          {
            "type": "p",
            "text": "また、接続形態によってIPアドレスが固定であるか可変であるかも異なり、Webアプリケーションのアクセス制御やログ管理に影響を与えます。"
          },
          {
            "type": "ul",
            "items": [
              "固定回線（光回線・ケーブル回線など）",
              "モバイル通信（4G/5G）",
              "公衆無線LAN（Wi-Fiスポット）",
              "家庭内LAN → ISP → インターネット → Webサーバの流れ"
            ]
          }
        ]
      },
      {
        "id": "connection-mechanism",
        "title": "接続の仕組み（可変IPアドレス、ダイヤルアップ接続）",
        "summary": "IPアドレスの割当方式と、従来のダイヤルアップ接続の特徴を学ぶ。",
        "content": [
          {
            "type": "p",
            "text": "インターネットへの接続では、ISPからIPアドレスが割り当てられます。一般的に家庭用回線やモバイル回線では“可変IPアドレス（動的IP）”が用いられ、接続のたびに異なるIPが割り当てられます。一方で企業やサーバ用途では“固定IP”を利用することが多く、常に同一のアドレスからアクセスできます。"
          },
          {
            "type": "p",
            "text": "また、インターネット草創期には“ダイヤルアップ接続”が主流で、電話回線を使ってISPに接続する方式でした。速度は遅いものの、NTTの電話回線を利用できる点が特徴でした。"
          },
          {
            "type": "ul",
            "items": [
              "可変（動的）IPアドレス：接続の度にIPが変わる",
              "固定IPアドレス：常に同一のグローバルIPを使用",
              "ダイヤルアップ接続：電話回線を使用、速度 56kbps 程度",
              "現在はブロードバンド接続が主流"
            ]
          }
        ]
      },
      {
        "id": "connection-methods",
        "title": "様々な接続方法（ISDN、専用線・OCN/ODN、DSL/ADSL）",
        "summary": "家庭や企業で利用されてきた多様なインターネット接続方式を学ぶ。",
        "content": [
          {
            "type": "p",
            "text": "インターネットには複数の接続方式が存在し、時代とともに高速化・安定化が進んできました。初期の電話回線を使った方式から、企業向けの専用線、家庭向けのADSL、現代の光回線に至るまで、多様な技術が利用されてきました。"
          },
          {
            "type": "p",
            "text": "ここでは、現在でも知識として重要なISDN、専用線、OCN/ODN、DSL/ADSLといった代表的な接続方式をまとめます。"
          },
          {
            "type": "ul",
            "items": [
              "ISDN（Integrated Services Digital Network）：デジタル電話回線を利用、アナログより高速（64kbps〜128kbps）",
              "専用線：企業専用の固定回線、安定性・セキュリティが高い",
              "OCN/ODN：ISPが提供する企業・個人向けの専用線/接続サービス",
              "DSL / ADSL：電話回線を利用する高速接続方式、最大数Mbps程度"
            ]
          },
          {
            "type": "p",
            "text": "これらの技術を理解することで、現代の光回線や5G接続がどのように発展してきたかをより深く理解することができます。"
          }
        ]
      }
    ]
  },
  {
    "key": "tcp-ip",
    "title": "TCP/IPとネットワークの階層",
    "lessons": [
      {
        "id": "tcpip-and-layered-network",
        "title": "TCP/IPとネットワークの階層",
        "summary": "TCP/IPは階層構造を持つプロトコル群であり、役割を分担することで柔軟で拡張性の高いネットワークを実現している。",
        "content": [
          {
            "type": "p",
            "text": "TCP/IPとは、インターネットで標準的に使われているプロトコル（通信ルール）の集まりを指します。単一のプロトコルではなく、複数のプロトコルを組み合わせた“プロトコルスイート”であり、世界中のネットワーク機器がこのルールに従って通信しています。"
          },
          {
            "type": "p",
            "text": "TCP/IPの大きな特徴は“階層構造”を採用していることです。通信の役割を複数の層に分けることで、物理的な配線の方式が変わっても、アプリケーション側の実装をほとんど変更せずに済むなど、高い柔軟性と拡張性を実現しています。"
          },
          {
            "type": "ul",
            "items": [
              "役割ごとに層を分ける → 「階層モデル」",
              "下位層の仕組みを意識せず、上位層を設計できる",
              "変更の影響範囲を限定できる（保守性が高い）",
              "インターネット全体を支える基本思想"
            ]
          }
        ]
      },
      {
        "id": "tcpip-layers-overview",
        "title": "TCP/IPの階層",
        "summary": "TCP/IPは一般的に4つの層（リンク層・ネットワーク層・トランスポート層・アプリケーション層）から構成される。",
        "content": [
          {
            "type": "p",
            "text": "TCP/IPの階層モデルは、一般的に次の4つの層として説明されます。下から順に「リンク層」「ネットワーク層」「トランスポート層」「アプリケーション層」です。アプリケーションは最上位層のみを意識して実装されますが、実際の通信ではすべての層が協調して動作します。"
          },
          {
            "type": "ul",
            "items": [
              "リンク層（ネットワークインターフェース層）：同一ネットワーク内でのフレーム送受信を担当",
              "ネットワーク層（インターネット層）：異なるネットワーク間でパケットを転送（IP）",
              "トランスポート層：アプリケーション間のデータ伝送を制御（TCP/UDP）",
              "アプリケーション層：HTTP・DNS・SMTPなど、具体的なサービスを提供"
            ]
          },
          {
            "type": "p",
            "text": "これ以降の小節では、それぞれの層がどのような役割を持ち、どのように連携してWebアプリケーションの通信を支えているのかを詳しく見ていきます。"
          }
        ]
      },
      {
        "id": "link-layer",
        "title": "リンク層（ネットワークインターフェース層）",
        "summary": "同一ネットワーク内で“どの機器に届けるか”を扱い、物理的な伝送に最も近い層。",
        "content": [
          {
            "type": "p",
            "text": "リンク層（ネットワークインターフェース層）は、同じネットワーク（同じLAN）内の機器同士の通信を担当する層です。ここではMACアドレスなどのハードウェアアドレスを用いて、「同じネットワーク内のどの機器にフレームを届けるか」を決定します。"
          },
          {
            "type": "p",
            "text": "イーサネット、Wi-Fi などの技術はこの層に属します。実際の電気信号や電波のやり取りに近い層であり、上位のネットワーク層（IP）から受け取ったデータを“フレーム”としてLAN内に流します。"
          },
          {
            "type": "ul",
            "items": [
              "MACアドレスを用いて同一LAN内の宛先機器を特定",
              "イーサネット、Wi-Fi などの規格がこの層に該当",
              "上位層から受け取ったパケットをフレームとして送受信",
              "スイッチングハブは主にこの層の情報（MACアドレス）を参照"
            ]
          }
        ]
      },
      {
        "id": "network-layer",
        "title": "ネットワーク層（インターネット層）",
        "summary": "IPアドレスを使って異なるネットワーク間でパケットを転送する層。",
        "content": [
          {
            "type": "p",
            "text": "ネットワーク層（インターネット層）は、IPアドレスを用いて“ネットワーク間”のデータ転送を行う層です。リンク層が同一LAN内の通信を担当するのに対し、ネットワーク層は異なるLAN同士をまたがってパケットを届けます。"
          },
          {
            "type": "p",
            "text": "この層の中心となるプロトコルがIP（Internet Protocol）であり、IPパケットには送信元と宛先のIPアドレスが含まれます。ルータはこのIPアドレス情報をもとに、どの経路に転送するかを判断します。"
          },
          {
            "type": "ul",
            "items": [
              "IPアドレスによるネットワーク間のルーティング",
              "ルータがネットワーク層のヘッダを参照して転送経路を決定",
              "インターネット全体を“ひとつのネットワーク”として見せるための要",
              "ICMP（エラーメッセージや到達確認）もこの層に属する"
            ]
          }
        ]
      },
      {
        "id": "transport-layer",
        "title": "トランスポート層",
        "summary": "アプリケーション同士の通信を提供し、信頼性や速度などの特性を決める層。",
        "content": [
          {
            "type": "p",
            "text": "トランスポート層は、送信元アプリケーションと宛先アプリケーションの間でデータをやり取りするための仕組みを提供する層です。代表的なプロトコルにTCPとUDPがあり、それぞれ“信頼性重視”と“速度重視”という異なる特性を持っています。"
          },
          {
            "type": "p",
            "text": "TCP（Transmission Control Protocol）は、パケットの再送制御や順序制御、輻輳制御などを行い、アプリケーションに対して“誤りのない連続したデータ”として見せる役割を担います。一方UDP（User Datagram Protocol）は、これらの制御をほとんど行わず、簡易で高速な通信を提供します。"
          },
          {
            "type": "ul",
            "items": [
              "TCP：信頼性の高いコネクション型通信（Web、メールなどで利用）",
              "UDP：軽量で高速なコネクションレス通信（DNS、動画配信、ゲームなど）",
              "ポート番号を用いてアプリケーションを識別（例：80番＝HTTP）",
              "上位のアプリケーション層に“データ配送サービス”を提供"
            ]
          }
        ]
      },
      {
        "id": "application-layer",
        "title": "アプリケーション層",
        "summary": "ユーザーに見える具体的なサービス（HTTP、DNS、メールなど）を提供する層。",
        "content": [
          {
            "type": "p",
            "text": "アプリケーション層は、ユーザーが直接利用するサービスを実現する層です。Webブラウザが利用するHTTP、ドメイン名をIPアドレスに変換するDNS、メール送受信のSMTP/POP3/IMAPなど、多くのアプリケーションプロトコルがこの層で動作します。"
          },
          {
            "type": "p",
            "text": "アプリケーション開発者は、通常この層のプロトコルを意識して実装を行い、その下にあるトランスポート層・ネットワーク層・リンク層はOSやミドルウェアが隠蔽してくれます。階層化のおかげで、アプリケーションは“下位の通信方式が変わっても基本的な動作を保てる”ようになっています。"
          },
          {
            "type": "ul",
            "items": [
              "HTTP：WebページやAPIをやり取りするプロトコル",
              "HTTPS：HTTP＋暗号化（TLS）による安全な通信",
              "DNS：ドメイン名からIPアドレスを引く“インターネットの電話帳”",
              "SMTP/POP3/IMAP：メール送受信のプロトコル"
            ]
          }
        ]
      },
      {
        "id": "network-address",
        "title": "ネットワークアドレス",
        "summary": "IPアドレスの中で“ネットワーク部分”を表すアドレスで、ネットワーク自体を識別する。",
        "content": [
          {
            "type": "p",
            "text": "ネットワークアドレスとは、IPアドレスのうち“ネットワークそのもの”を表す部分のことです。IPアドレスは「ネットワーク部」と「ホスト部」に分かれており、そのネットワーク部だけを取り出したものがネットワークアドレスです。"
          },
          {
            "type": "p",
            "text": "ネットワークアドレスを理解することは、どのIPアドレスが同じネットワーク（同じLAN）に属しているのかを判断するうえで重要です。ルータやスイッチは、この情報をもとにパケットをどこへ転送するかを決定します。"
          },
          {
            "type": "ul",
            "items": [
              "例：192.168.1.0/24 → ネットワークアドレスは 192.168.1.0",
              "同じネットワーク内のホストは同じネットワークアドレスを持つ",
              "サブネットマスクと組み合わせて“どこまでがネットワーク部か”を表現"
            ]
          }
        ]
      },
      {
        "id": "global-address",
        "title": "グローバルアドレス",
        "summary": "インターネット上で一意に割り当てられ、世界中から到達可能なIPアドレス。",
        "content": [
          {
            "type": "p",
            "text": "グローバルアドレスとは、インターネット上で一意に割り当てられ、世界中のどこからでもルーティング可能なIPアドレスです。Webサーバやクラウドサーバ、企業ネットワークの出口などはグローバルアドレスを利用して、インターネットからのアクセスを受け取ります。"
          },
          {
            "type": "p",
            "text": "一方、家庭や社内LANではプライベートアドレス（例：192.168.x.x）が使われ、ルータでNAT（アドレス変換）を行うことで、1つのグローバルアドレスを複数端末で共有することが多くなっています。"
          },
          {
            "type": "ul",
            "items": [
              "インターネット上で重複しないよう管理されている",
              "Webサーバなど“外部から直接アクセスされる機器”で利用",
              "プライベートアドレスはLAN内専用で、インターネットから直接は見えない",
              "家庭用ルータはNAT機能でプライベート⇔グローバルを変換"
            ]
          }
        ]
      },
      {
        "id": "ip-address",
        "title": "IPアドレス",
        "summary": "ネットワーク上の機器を識別するための“住所”であり、IPv4とIPv6の2種類がある。",
        "content": [
          {
            "type": "p",
            "text": "IPアドレスは、ネットワーク上の機器を識別するための“住所”のようなものです。IPv4では32ビットの数値を用い、通常は「192.168.0.1」のように「ドット区切りの10進数」で表記します。IPv6では128ビットを用い、「2001:db8::1」のような表記になります。"
          },
          {
            "type": "p",
            "text": "IPアドレスは「ネットワーク部」と「ホスト部」に分かれており、どこまでがネットワーク部なのかを示すのがサブネットマスク（またはCIDR表記の /24、/16 など）です。"
          },
          {
            "type": "ul",
            "items": [
              "IPv4：32ビット、約43億個のアドレス空間",
              "IPv6：128ビット、ほぼ枯渇しない巨大なアドレス空間",
              "例：192.168.1.10/24 → ネットワーク部は192.168.1、ホスト部は10",
              "同一ネットワークかどうかの判定にIPアドレスとサブネットマスクを使用"
            ]
          }
        ]
      },
      {
        "id": "address-classes",
        "title": "アドレスのクラス",
        "summary": "古典的なIPv4アドレスの分類方法で、ネットワーク規模に応じてクラスA〜Cなどに分けられる。",
        "content": [
          {
            "type": "p",
            "text": "アドレスのクラスとは、古典的なIPv4のアドレス空間をネットワーク規模に応じてクラスA〜Eに分類した考え方です。現在はCIDRによる柔軟な割り当てが主流ですが、基礎知識としてクラスの概念を理解しておくことは有用です。"
          },
          {
            "type": "p",
            "text": "クラスAは大規模ネットワーク向け、クラスBは中規模、クラスCは小規模ネットワーク向けのアドレス帯として設計されました。一部は予約され、特殊用途（マルチキャストなど）に利用されます。"
          },
          {
            "type": "ul",
            "items": [
              "クラスA：0.0.0.0〜127.255.255.255（先頭ビット 0）",
              "クラスB：128.0.0.0〜191.255.255.255（先頭ビット 10）",
              "クラスC：192.0.0.0〜223.255.255.255（先頭ビット 110）",
              "クラスD：マルチキャスト用（224.0.0.0〜239.255.255.255）",
              "クラスE：将来予約（240.0.0.0〜255.255.255.255）",
              "現在の割り当てはCIDR（/24など）で行われるのが一般的"
            ]
          }
        ]
      },
      {
        "id": "router",
        "title": "ルータ",
        "summary": "異なるネットワーク同士を中継し、IPアドレスに基づいて最適な経路へパケットを転送する装置。",
        "content": [
          {
            "type": "p",
            "text": "ルータは、複数のネットワークを相互に接続し、IPパケットを適切な経路へ転送する装置です。ネットワーク層の情報（IPアドレス、ネットワークアドレス）を参照して、どのインターフェースへパケットを送るべきかを決定します。"
          },
          {
            "type": "p",
            "text": "家庭用のブロードバンドルータは、ルーティングだけでなく、NAT機能やDHCPサーバ機能、無線LANアクセスポイント機能などを兼ね備えた“多機能ルータ”であることが多く、LANとインターネットをつなぐ“玄関口”として動作します。インターネット全体を見れば、無数のルータが連携してパケットの経路（ルート）を構築していることになります。"
          },
          {
            "type": "ul",
            "items": [
              "IPアドレスとルーティングテーブルにもとづいて転送先を決定",
              "異なるLANやISP間を中継する役割",
              "BGPやOSPFなどのルーティングプロトコルで経路情報を交換",
              "家庭用ルータはNAT・DHCP・無線LANなどを統合した“オールインワン装置”が一般的"
            ]
          }
        ]
      }
    ]
  },
  {
    "key": "what-is-tcp-ip",
    "title": "TCP/IPとは何か",
    "lessons": [
      {
        "id": "tcpip-definition",
        "title": "TCP/IPとは何か",
        "summary": "TCP/IPは単一のプロトコルではなく、インターネットを構成する多数の通信プロトコルをまとめた“プロトコルスイート”である。",
        "content": [
          {
            "type": "p",
            "text": "TCP/IPとは、インターネットを動かすために必要な通信規則（プロトコル）をまとめた“プロトコルスイート（Protocol Suite）”のことです。TCPやIPはその中の代表的プロトコルであり、それらの名前を取って「TCP/IP」と呼ばれています。つまり、TCP/IPは単一のプロトコルではなく、“通信技術の集合”です。"
          },
          {
            "type": "p",
            "text": "このTCP/IPスイートには、HTTP、DNS、TCP、UDP、IP、ARP、DHCPなど、インターネット通信に必要な多くのプロトコルが含まれています。"
          }
        ]
      },
      {
        "id": "why-called-tcpip",
        "title": "なぜTCP/IPと呼ばれるのか",
        "summary": "TCPとIPがインターネット通信の中核となるため、その名称がスイート全体の名前として使われる。",
        "content": [
          {
            "type": "p",
            "text": "インターネット通信の最も重要な基盤となるプロトコルが TCP と IP であるため、インターネットを構成するプロトコル群全体を便宜的に「TCP/IP」と呼びます。しかし、実際には多数のプロトコルがこの体系に含まれています。"
          }
        ]
      },
      {
        "id": "tcpip-protocol-suite",
        "title": "TCP/IPはプロトコルスイート",
        "summary": "TCP/IPは多くのプロトコルを含む体系であり、インターネットの根幹をなす技術群である。",
        "content": [
          {
            "type": "p",
            "text": "TCP/IPの正式名称は“Internet Protocol Suite”であり、複数のプロトコルを一つの体系としてまとめたものです。HTTP、DNS、SMTP、NTP、TCP、UDP、IPといった多様なプロトコルが含まれ、それぞれ異なる役割を持っています。"
          },
          {
            "type": "p",
            "text": "これらのプロトコルが協調することで、Web閲覧、メール、動画、オンラインゲームなど、あらゆるインターネットサービスが成立しています。"
          }
        ]
      },
      {
        "id": "tcpip-4layers",
        "title": "TCP/IPの4層モデル",
        "summary": "TCP/IPは多数のプロトコルを役割ごとに4つの層に分類した構造を持つ。",
        "content": [
          {
            "type": "p",
            "text": "TCP/IPは大量のプロトコルを整理するために「4層モデル」を採用しています。この4層はプロトコルそのものではなく、“役割別に分類した構造”です。"
          },
          {
            "type": "ul",
            "items": [
              "【1. アプリケーション層】HTTP, DNS, SMTP などサービスに直接関わる層",
              "【2. トランスポート層】TCP・UDP による通信制御（信頼性や速度調整）",
              "【3. インターネット層】IP によるパケットの配送・ルーティング",
              "【4. リンク層】イーサネットやWi-Fiなど物理的な通信方式"
            ]
          },
          {
            "type": "p",
            "text": "この4層モデルは“プロトコルがどの役割を果たしているのか”を理解するための枠組みです。層は概念分類であり、各層に複数のプロトコルが所属する形になります。"
          }
        ]
      },
      {
        "id": "protocol-vs-layer",
        "title": "プロトコルと階層の関係",
        "summary": "TCP/IPはプロトコルで構成され、4層はそれらプロトコルを分類するための枠組みである。",
        "content": [
          {
            "type": "p",
            "text": "多くの人が混乱するポイントは「TCP/IPはプロトコルなのか、階層なのか」という点です。正確には、TCP/IPは“プロトコル体系”であり、4層モデルはその体系に属するプロトコルを分類するための枠組みにすぎません。"
          },
          {
            "type": "p",
            "text": "つまり、TCP/IPという単語は以下の2つの意味を併せ持ちます："
          },
          {
            "type": "ul",
            "items": [
              "① インターネットのためのプロトコル群（HTTP, TCP, IP など）",
              "② それらのプロトコルを4つの層に整理したモデル"
            ]
          }
        ]
      },
      {
        "id": "tcpip-analogy",
        "title": "比喩で理解するTCP/IP",
        "summary": "TCP/IPは学校や組織に例えると理解しやすい。",
        "content": [
          {
            "type": "p",
            "text": "TCP/IPをわかりやすく例えると「学校」に似ています。"
          },
          {
            "type": "ul",
            "items": [
              "学校（TCP/IP全体）＝プロトコルスイート",
              "学年・クラス（4層）＝役割別の分類",
              "生徒（HTTP, TCP, IP など）＝個々のプロトコル"
            ]
          },
          {
            "type": "p",
            "text": "つまり、TCP/IPという学校には、HTTPやDNSなど多くの“生徒”がいて、4つの“クラス（層）”に分かれているというイメージです。"
          }
        ]
      },
      {
        "id": "tcpip-summary",
        "title": "まとめ：TCP/IPの本質",
        "summary": "TCP/IPはプロトコルの集合体であり、4層構造はその整理方法である。",
        "content": [
          {
            "type": "p",
            "text": "TCP/IPは多くのプロトコルを束ねた体系であり、4層モデルはそれを理解しやすくするための分類です。TCPとIPはその中核であるため体系全体の名称として使われています。"
          },
          {
            "type": "ul",
            "items": [
              "✔ TCP/IPは単一のプロトコルではない",
              "✔ TCP/IPはインターネットを構成するプロトコル群（スイート）",
              "✔ プロトコルは4つの層に分類される（アプリケーション〜リンク層）",
              "✔ TCPとIPが中心なので全体をTCP/IPと呼ぶ"
            ]
          }
        ]
      }
    ]
  },
  
  {
    "key": "tcp-ip-protocols",
    "title": "TCP/IP上のプロトコル",
    "lessons": [
      {
        "id": "main-protocols",
        "title": "主なプロトコル",
        "summary": "TCP/IPで利用される主要なアプリケーション層プロトコルを理解し、用途と特徴を把握する。",
        "content": [
          {
            "type": "p",
            "text": "TCP/IPには多くのプロトコルが存在しますが、特にアプリケーション層のプロトコルはWebアプリケーション、メール、認証、時刻同期などに直接関わるため非常に重要です。ここでは、現代のネットワーク環境において基礎となる主要プロトコルを一つずつ詳細に整理します。"
          },
          {
            "type": "ul",
            "items": [
              "【HTTP（HyperText Transfer Protocol）】",
              "WebブラウザとWebサーバの間でHTMLや画像を送受信するプロトコル。現在はHTTPS（TLSを利用した暗号化）が主流。",
              "",
              "【FTP（File Transfer Protocol）】",
              "サーバとクライアント間でファイルを転送するプロトコル。ユーザー名とパスワードを使うが暗号化が弱いため、近年はSFTP/FTPSの利用が増加。",
              "",
              "【TELNET】",
              "遠隔端末接続用のプロトコル。通信が暗号化されないため、現在はSSHが主流。",
              "",
              "【SMTP（Simple Mail Transfer Protocol）】",
              "メールを“送信”するためのプロトコル。メールサーバ間のリレーにも使用される。",
              "",
              "【POP（Post Office Protocol）】",
              "メールをサーバからダウンロードする方式のプロトコル（POP3）。基本的にメールは“端末に保存”され、サーバから削除されやすい。",
              "",
              "【IMAP（Internet Message Access Protocol）】",
              "サーバ上のメールを保持したまま複数端末で同期できるプロトコル。現代のメールクライアントの主流。",
              "",
              "【NNTP（Network News Transfer Protocol）】",
              "電子掲示板（ネットニュース）で利用されるプロトコル。現在は利用機会は少ないが歴史的に重要。",
              "",
              "【NTP（Network Time Protocol）】",
              "ネットワーク上の時刻を同期するプロトコル。サーバ間・端末間のログ整合性に必須。",
              "",
              "【SNTP（Simple NTP）】",
              "NTPを簡略化したプロトコル。精度は劣るが、一般端末やIoT機器などで利用される。",
              "",
              "【LDAP（Lightweight Directory Access Protocol）】",
              "ユーザー情報・権限・組織情報を管理する“ディレクトリサービス”用プロトコル。Active Directoryなどで使用される。",
              "",
              "【BOOTP（Bootstrap Protocol）】",
              "IPアドレスや起動情報を自動配布する古いプロトコル。DHCPの前身。",
              "",
              "【DHCP（Dynamic Host Configuration Protocol）】",
              "端末にIPアドレス・サブネットマスク・DNS情報を自動配布するプロトコル。現在すべてのネットワークで標準的に利用される。"
            ]
          },
          {
            "type": "p",
            "text": "これらのプロトコルはインターネットサービスや業務システムの基礎を支える役割を持ち、それぞれの用途や特徴を理解することで、Webアプリケーションの挙動・ネットワーク障害の原因究明・セキュリティ対策などに役立ちます。"
          }
        ]
      },
      {
        "id": "port-numbers",
        "title": "ポート番号",
        "summary": "TCP/UDP通信でアプリケーションを識別するために使用される番号で、Webやメールの動作に必須の基礎知識。",
        "content": [
          {
            "type": "p",
            "text": "ポート番号は、IPアドレスが“機器”を示すのに対し、その機器内で動作する“アプリケーション（サービス）”を識別するための番号です。TCPまたはUDPのヘッダ内で指定され、どのサービスにデータを届けるべきかを判断します。"
          },
          {
            "type": "ul",
            "items": [
              "【ウェルノウンポート（0〜1023）】主要プロトコルが使用",
              "・80：HTTP",
              "・443：HTTPS",
              "・21：FTP",
              "・23：TELNET",
              "・25：SMTP",
              "・110：POP3",
              "・143：IMAP",
              "・123：NTP",
              "・389：LDAP",
              "",
              "【登録ポート（1024〜49151）】一般アプリケーション用",
              "・3306：MySQL",
              "・5432：PostgreSQL",
              "・8080：代替HTTP",
              "",
              "【動的 / プライベートポート（49152〜65535）】",
              "・クライアント側が利用する一時ポート（Ephemeral Ports）"
            ]
          },
          {
            "type": "p",
            "text": "Webブラウザは通常、49152〜65535 の範囲からランダムなポートを使用してサーバへ接続し、サーバ側は 80 や 443 など特定のポートで待ち受けます。この仕組みにより一台のPCが複数の通信を同時に処理できます。"
          },
          {
            "type": "p",
            "text": "ポート番号はファイアウォール設定やセキュリティ管理にも深く関わるため、ネットワーク管理やサーバ運用において重要な知識となります。"
          }
        ]
      }
    ]
  },
  {
    "key": "domain-and-url",
    "title": "ドメインとURL",
    "lessons": [
      {
        "id": "domain",
        "title": "ドメイン",
        "summary": "インターネット上の住所として機能する文字列で、IPアドレスを人間にとって扱いやすくしたもの。",
        "content": [
          {
            "type": "p",
            "text": "ドメインとは、インターネット上の“住所”を表す文字列で、本来は数値で表されるIPアドレスを、人間が覚えやすい形にしたものです。例えば、Googleのサーバは実際にはIPアドレスでアクセスできますが、人間にとっては「google.com」の方が扱いやすいため、ドメインが利用されています。"
          },
          {
            "type": "p",
            "text": "ドメイン名は右から左へ階層が深くなる構造を持ち、例として「www.example.com」は、com（トップレベルドメイン）、example（セカンドレベル）、www（サブドメイン）で構成されます。"
          }
        ]
      },
      {
        "id": "domain-rules",
        "title": "ドメイン名のルール",
        "summary": "ドメイン名の構造や命名規則、トップレベルドメイン（TLD）の種類を理解する。",
        "content": [
          {
            "type": "p",
            "text": "ドメイン名には国際的に定められたルールがあり、適切な命名を行うためには基本的な仕組みを理解しておく必要があります。"
          },
          {
            "type": "ul",
            "items": [
              "・英数字（a〜z、0〜9）およびハイフン（-）のみ使用可能",
              "・ハイフンで始めたり終わったりできない",
              "・各ラベル（例：example）は最大63文字",
              "・全体の長さは253文字以内",
              "・ドメインは階層構造（TLD → SLD → サブドメイン）",
              "・TLDの主な分類：",
              "　- gTLD（.com, .net, .org など）",
              "　- ccTLD（.jp, .cn, .us など）",
              "　- 新gTLD（.app, .dev, .shop など）"
            ]
          },
          {
            "type": "p",
            "text": "日本では「.jp」の下に「.co.jp」「.ne.jp」などの属性型JPドメインがあり、用途に応じて選ばれます。"
          }
        ]
      },
      {
        "id": "dns",
        "title": "DNS",
        "summary": "ドメイン名をIPアドレスへ変換する仕組みを提供するインターネットの基盤。",
        "content": [
          {
            "type": "p",
            "text": "DNS（Domain Name System）は、ドメイン名をIPアドレスへ変換するための仕組みで、インターネットの動作に欠かせない基盤技術です。ユーザーが「www.example.com」にアクセスできるのは、内部でDNSが自動的にIPアドレスを検索しているためです。"
          },
          {
            "type": "p",
            "text": "DNSは階層的な分散データベースとして構成され、ルートDNS、TLD DNS、権威DNSなどが協調して名前解決を行います。"
          },
          {
            "type": "ul",
            "items": [
              "・ルートDNSサーバ：名前解決の起点",
              "・TLD DNSサーバ：.com、.jp などのトップレベルドメインを管理",
              "・権威DNSサーバ：実際のドメインのIP情報を保持",
              "・リゾルバ：クライアントの代わりにDNS問い合わせを行う"
            ]
          }
        ]
      },
      {
        "id": "ddns",
        "title": "DDNS（Dynamic DNS）",
        "summary": "可変IPアドレスを持つ環境でもドメイン名でアクセスできるようにする仕組み。",
        "content": [
          {
            "type": "p",
            "text": "DDNS（Dynamic DNS）は、IPアドレスが頻繁に変わる環境でも、常に同じドメイン名でアクセスできるようにする仕組みです。家庭用インターネット回線の多くは動的IPアドレスのため、IPが変わるたびにDNS情報を更新する必要があります。"
          },
          {
            "type": "p",
            "text": "DDNSサービスはこの更新を自動化し、可変IPでも固定ドメイン名のように利用できるため、リモートアクセスや家庭用サーバなどで広く使われています。"
          }
        ]
      },
      {
        "id": "name-resolution",
        "title": "名前解決",
        "summary": "ホスト名からIPアドレスを求めるプロセスであり、DNSによって実現される。",
        "content": [
          {
            "type": "p",
            "text": "名前解決とは、ホスト名（例：www.example.com）からそのマシンのIPアドレスを求める処理のことです。これはDNSを用いて行われる基本的なネットワーク動作であり、インターネットアクセスに欠かせない仕組みです。"
          },
          {
            "type": "p",
            "text": "ユーザーがブラウザにURLを入力すると、コンピュータは以下の手順でDNSを利用してIPアドレスを検索します。"
          },
          {
            "type": "ul",
            "items": [
              "① まずローカルPCのDNSキャッシュを検索する",
              "② キャッシュが無ければリゾルバ（通常はISPのDNS）へ問い合わせる",
              "③ リゾルバがルートDNSに問い合わせを開始",
              "④ TLD DNS → 権威DNSの順に辿ってIP情報を取得",
              "⑤ リゾルバが最終的なIPアドレスをPCに返信する",
              "⑥ PCは取得したIPアドレス宛に通信を開始する（HTTP, HTTPSなど）"
            ]
          },
          {
            "type": "p",
            "text": "このように、名前解決はインターネット上の通信を始めるための最初のステップであり、ドメイン名という人間に優しい仕組みをコンピュータが理解可能なIPアドレスへ変換する重要な役割を担っています。"
          }
        ]
      },
      {
        "id": "url-and-uri",
        "title": "URLとURI",
        "summary": "Web上のリソースを識別するURIと、その中で具体的な場所を示すURLの違いを理解する。",
        "content": [
          {
            "type": "p",
            "text": "URI（Uniform Resource Identifier）は、Web上のリソースを識別するための文字列全体を指す広い概念です。その中で、具体的な場所（Location）を示すものがURL（Uniform Resource Locator）です。"
          },
          {
            "type": "ul",
            "items": [
              "URI：リソースを識別するための最も広い概念",
              "URL：URIの一種で、リソースの場所を示す",
              "URN：名前によって識別する方式（例：ISBN番号など）"
            ]
          },
          {
            "type": "p",
            "text": "例えば「https://www.example.com/index.html」はURLですが、同時にURIの一種とも言えます。実務ではURLという用語が一般的ですが、技術文書ではURIが用いられることもあります。"
          }
        ]
      }
    ]
  },
  {
    "key": "rest",
    "title": "RESTと関連技術",
    "lessons": [
      {
        "id": "rest-resource",
        "title": "リソース",
        "summary": "RESTでは「操作」ではなく「リソース（資源）」を中心にAPIを設計する。リソースはURIで一意に識別される。",
        "content": [
          {
            "type": "p",
            "text": "REST（Representational State Transfer）は、Webの仕組みをうまく活用するためのアーキテクチャスタイルです。RESTでは何かの“操作”を直接呼び出すのではなく、「リソース（資源）」を中心に考えます。ユーザー、記事、商品、注文など、アプリケーションで扱う対象をすべて“リソース”として捉えます。"
          },
          {
            "type": "p",
            "text": "それぞれのリソースは、URI（URL）によって一意に識別されます。例えば、/users は「ユーザー集合」というリソース、/users/123 は「ID=123 のユーザー」というリソースを表します。"
          },
          {
            "type": "ul",
            "items": [
              "・リソースはアプリケーション内の“名詞”で表される対象（ユーザー、商品、注文など）",
              "・リソースはURIで一意に識別される（/users, /users/1, /articles/10 など）",
              "・HTTPメソッド（GET, POST, PUT, DELETE など）によってリソースへの操作を表現する"
            ]
          },
          {
            "type": "p",
            "text": "RESTfulなAPI設計では「/createUser」「/doUpdate」など“動詞だらけのURL”ではなく、「/users」「/users/123」のように“リソースを表すURL”を意識することが重要です。"
          }
        ]
      },
      {
        "id": "rest-state-representation",
        "title": "状態と表現",
        "summary": "RESTの“R”は“Representational”であり、リソースの“状態”をJSONなどの“表現”としてやり取りすることを意味する。",
        "content": [
          {
            "type": "p",
            "text": "RESTの正式名称は“Representational State Transfer”であり、直訳すると「表現された状態の転送」です。ここで重要なのは、クライアントとサーバが直接リソースそのものをやり取りするのではなく、“リソースの状態（State）を表現したデータ（Representation）”をやり取りするという考え方です。"
          },
          {
            "type": "p",
            "text": "例えば、「ユーザー」というリソースの状態は、JSON形式やXML、HTMLなどで表現されます。クライアントはサーバから“ユーザーの現在の状態を表現したJSON”を受け取り、それを画面に表示します。"
          },
          {
            "type": "ul",
            "items": [
              "・State（状態）：リソースが現在持っている情報（例：ユーザー名、メールアドレス）",
              "・Representation（表現）：その状態を表すデータ形式（JSON, XML, HTMLなど）",
              "・クライアントとサーバは、この“表現された状態”をHTTPで送受信する"
            ]
          },
          {
            "type": "p",
            "text": "Webアプリケーションでは、主にJSONが使われます。RESTを理解するうえでは、「サーバはリソースの状態をJSONという表現で返し、クライアントはそれを解釈する」というイメージを持つと分かりやすくなります。"
          }
        ]
      },
      {
        "id": "rest-constraints",
        "title": "RESTを構成する制約",
        "summary": "RESTは具体的な技術やフレームワークの名前ではなく、“いくつかの制約を満たすシステム設計スタイル”である。",
        "content": [
          {
            "type": "p",
            "text": "RESTは特定のライブラリやフレームワークの名前ではなく、“いくつかの制約（Constraints）を満たすシステム設計スタイル”です。これらの制約を守ることで、スケーラブルで変更に強く、キャッシュしやすいWebシステムを構築できます。"
          },
          {
            "type": "ul",
            "items": [
              "① クライアント・サーバ（Client-Server）",
              "　・UIやアプリロジックを担当するクライアントと、データやビジネスロジックを担当するサーバを分離する。",
              "",
              "② ステートレス（Stateless）",
              "　・各HTTPリクエストは“それだけで完結”しており、サーバ側は前回のリクエスト状態を保持しない。",
              "　・必要な情報は毎回リクエストに含める（認証トークンなど）。",
              "",
              "③ キャッシュ可能（Cacheable）",
              "　・レスポンスはキャッシュ可能かどうかを明示し、クライアントやプロキシはキャッシュを活用できる。",
              "",
              "④ 統一インターフェース（Uniform Interface）",
              "　・HTTPメソッド（GET, POST, PUT, DELETEなど）やステータスコードを一貫して利用する。",
              "　・リソース指向のURI設計を行う。",
              "",
              "⑤ 階層システム（Layered System）",
              "　・クライアントは中継プロキシなのか、最終サーバなのかを意識しない。",
              "　・ロードバランサーやキャッシュサーバを途中に挟んでも、全体としては同じように動作する。",
              "",
              "⑥ コード・オン・デマンド（任意）（Code on Demand）",
              "　・必要に応じてサーバがクライアントへコード（JavaScriptなど）を送り、動作を拡張できる。"
            ]
          },
          {
            "type": "p",
            "text": "「RESTfulなAPI」とは、これらの制約、とりわけ“リソース指向”“ステートレス”“HTTPの一貫した利用”を意識して設計されたAPIを指すことが多いです。"
          }
        ]
      },
      {
        "id": "rpc",
        "title": "RPC",
        "summary": "RPCは「リモート関数呼び出し」を行うスタイルで、RESTのようにリソース中心ではなく“操作（メソッド）中心”の設計になることが多い。",
        "content": [
          {
            "type": "p",
            "text": "RPC（Remote Procedure Call）は、ネットワーク越しに“遠隔の関数（手続き）を呼び出す”という発想のスタイルです。ローカル関数を呼ぶのと同じように、ネットワーク上の別マシンにある関数を呼び出すことを目標としています。"
          },
          {
            "type": "p",
            "text": "RESTが「リソース（名詞）」中心の設計なのに対して、RPCは「操作（動詞）」中心の設計になりやすく、/createUser、/updateUserName といった“何をするか”をそのままエンドポイント名に表現することが多いです。"
          },
          {
            "type": "ul",
            "items": [
              "・RPC：クライアント → サーバの“関数呼び出し”を抽象化したモデル",
              "・エンドポイント名は“操作名”になりやすい（/doLogin, /calculate など）",
              "・通信方式やデータ形式は実装やフレームワークによってさまざま",
              "・RESTと比較して“リソース指向”ではなく“手続き指向”の傾向が強い"
            ]
          },
          {
            "type": "p",
            "text": "どちらが絶対に優れているということはなく、「第三者公開APIならRESTが分かりやすい」「内部マイクロサービス間ではRPCが実装しやすい」など、用途によって使い分けられています。"
          }
        ]
      },
      {
        "id": "grpc",
        "title": "gRPC",
        "summary": "gRPCはGoogleが開発した高速なRPCフレームワークで、HTTP/2とProtocol Buffersを利用して効率的なマイクロサービス間通信を実現する。",
        "content": [
          {
            "type": "p",
            "text": "gRPCは、Googleが開発したオープンソースのRPCフレームワークで、高速かつ型安全なサービス間通信を実現するために設計されています。HTTP/2をベースとし、バイナリ形式のProtocol Buffers（Protobuf）でデータをやり取りします。"
          },
          {
            "type": "p",
            "text": "gRPCでは、まず .proto ファイルにサービスとメソッド、メッセージ構造を定義し、そこから各言語用のクライアント・サーバコードを自動生成します。これにより、多言語環境でも統一されたインターフェースを保ちやすくなります。"
          },
          {
            "type": "ul",
            "items": [
              "・RPCスタイルのフレームワーク（関数呼び出しベース）",
              "・HTTP/2 上で動作し、ストリーミング通信にも対応",
              "・Protocol Buffers によるバイナリフォーマットで高速・省帯域",
              "・マイクロサービス間通信や内部APIでよく利用される"
            ]
          },
          {
            "type": "p",
            "text": "REST（JSON＋HTTP/1.1）が“人間や外部公開向けの汎用API”として広く使われるのに対し、gRPCは“サービス間の効率的な内部通信”に向いているケースが多いです。実務では、外部APIはREST、内部マイクロサービスはgRPCといった使い分けもよく行われます。"
          }
        ]
      }
    ]
  }
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
];


/** ---------- 难度徽章样式 ---------- */
const levelBadge: Record<NonNullable<Lesson["level"]>, string> = {
  basic: "bg-emerald-500/20 text-emerald-600 border border-emerald-500/30 dark:text-emerald-300",
  intermediate: "bg-sky-500/20 text-sky-600 border border-sky-500/30 dark:text-sky-300",
  advanced: "bg-violet-500/20 text-violet-600 border border-violet-500/30 dark:text-violet-300",
};

/** ---------- 滚动联动 ---------- */
function useScrollSpy(ids: string[], offset = 120) {
  const [activeId, setActiveId] = useState<string | null>(null);
  useEffect(() => {
    const handler = () => {
      let current: string | null = null;
      for (const id of ids) {
        const el = document.getElementById(id);
        if (!el) continue;
        const rect = el.getBoundingClientRect();
        if (rect.top <= offset) current = id;
        else break;
      }
      setActiveId(current ?? ids[0] ?? null);
    };
    handler();
    window.addEventListener("scroll", handler, { passive: true });
    return () => window.removeEventListener("scroll", handler);
  }, [ids, offset]);
  return activeId;
}

/** ---------- 页面组件 ---------- */
export default function TsBasicsPage() {
  const [query, setQuery] = useState("");
  const [theme, setTheme] = useState<"light" | "dark">("light");

  // 切换主题
  const toggleTheme = () => {
    setTheme((prev) => (prev === "light" ? "dark" : "light"));
  };

  // 搜索过滤
  const filtered = useMemo(() => {
    const q = query.trim().toLowerCase();
    if (!q) return CURRICULUM;
    return CURRICULUM.map((c) => ({
      ...c,
      lessons: c.lessons.filter(
        (lsn) =>
          lsn.title.toLowerCase().includes(q) ||
          (lsn.summary ?? "").toLowerCase().includes(q) ||
          lsn.content.some((node) => {
            if (node.type === "p") return node.text.toLowerCase().includes(q);
            if (node.type === "code")
              return node.code.toLowerCase().includes(q) || (node.filename ?? "").toLowerCase().includes(q);
            if (node.type === "ul") return node.items.some((t) => t.toLowerCase().includes(q));
            return false;
          })
      ),
    })).filter((c) => c.lessons.length > 0);
  }, [query]);

  // ScrollSpy
  const allIds = useMemo(() => filtered.flatMap((c) => c.lessons.map((l) => l.id)), [filtered]);
  const activeId = useScrollSpy(allIds);

  return (
    <div className={`${theme === "dark" ? "bg-neutral-950 text-neutral-100" : "bg-white text-neutral-900"} min-h-screen transition-colors`}>
      {/* 顶部条 */}
      <header
        className={`sticky top-0 z-40 border-b backdrop-blur ${
          theme === "dark"
            ? "border-white/10 bg-neutral-950/70"
            : "border-neutral-200 bg-white/80"
        }`}
      >
        <div className="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
          {/* ✅ 新增：返回首页按钮 */}
          <Link
            href="/"
            className={`flex items-center gap-1 px-2 py-1 rounded-lg border text-sm transition ${
              theme === "dark"
                ? "border-white/20 hover:bg-white/10 text-white"
                : "border-neutral-300 hover:bg-neutral-100 text-neutral-800"
            }`}
          >
            <ChevronRight className="w-4 h-4 -rotate-180" />
            <span>トップページ</span>
          </Link>

          <BookOpen className="w-5 h-5 opacity-80 ml-2" />
          <h1 className="text-lg font-semibold tracking-wide">
            Webアプリケーションの構成
          </h1>

          <button
            onClick={toggleTheme}
            className={`ml-auto flex items-center gap-1 px-2 py-1 rounded-lg border transition ${
              theme === "dark"
                ? "border-white/20 hover:bg-white/10"
                : "border-neutral-300 hover:bg-neutral-100"
            }`}
          >
            {theme === "dark" ? <Sun className="w-4 h-4" /> : <Moon className="w-4 h-4" />}
            <span className="text-sm">{theme === "dark" ? "昼" : "夜"}</span>
          </button>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-4 py-6 grid grid-cols-12 gap-6">
        {/* ✅ 左侧目录：aside 自身 sticky + overflow，独立滚动 */}
        <aside
          className={`
            col-span-12 lg:col-span-4 xl:col-span-3
            sticky top-[72px]
            max-h-[calc(100vh-72px)]
            overflow-y-auto overscroll-contain
            pr-2 pb-10
          `}
        >
          <label
            className={`flex items-center gap-2 rounded-xl px-3 py-2 border mb-3 ${
              theme === "dark"
                ? "bg-white/5 border-white/10 focus-within:border-white/20"
                : "bg-neutral-100 border-neutral-300 focus-within:border-neutral-400"
            }`}
          >
            <Search className="w-4 h-4 opacity-70" />
            <input
              value={query}
              onChange={(e) => setQuery(e.target.value)}
              placeholder="キーワードを検索…"
              className={`bg-transparent outline-none w-full text-sm ${
                theme === "dark" ? "placeholder:text-neutral-400" : "placeholder:text-neutral-500"
              }`}
            />
          </label>

          <nav className="space-y-5">
            {filtered.map((chapter) => (
              <div key={chapter.key} className="space-y-2">
                <div
                  className={`text-xs uppercase tracking-wider ${
                    theme === "dark" ? "text-neutral-400" : "text-neutral-500"
                  }`}
                >
                  {chapter.title}
                </div>
                <ul className="space-y-1">
                  {chapter.lessons.map((l) => (
                    <li key={l.id}>
                      <a
                        href={`#${l.id}`}
                        className={`group flex items-center gap-2 rounded-lg px-3 py-2 border text-sm transition-all ${
                          activeId === l.id
                            ? theme === "dark"
                              ? "border-white/30 bg-white/10"
                              : "border-neutral-400 bg-neutral-100"
                            : theme === "dark"
                            ? "border-white/10 hover:border-white/20 hover:bg-white/5"
                            : "border-neutral-300 hover:border-neutral-400 hover:bg-neutral-50"
                        }`}
                      >
                        <ChevronRight className="w-4 h-4 opacity-70 group-hover:translate-x-0.5 transition-transform" />
                        <span className="flex-1">{l.title}</span>
                        {l.level && (
                          <span className={`text-[10px] px-2 py-0.5 rounded-full ${levelBadge[l.level]}`}>
                            {l.level}
                          </span>
                        )}
                        {typeof l.estMin === "number" && (
                          <span
                            className={`text-[10px] ${
                              theme === "dark" ? "text-neutral-300/80" : "text-neutral-500"
                            }`}
                          >
                            {l.estMin}m
                          </span>
                        )}
                      </a>
                    </li>
                  ))}
                </ul>
              </div>
            ))}
          </nav>
        </aside>

        {/* 右侧内容 */}
        <section className="col-span-12 lg:col-span-8 xl:col-span-9">
          <article className="space-y-10">
            {filtered.map((chapter) => (
              <div key={chapter.key} className="space-y-8">
                {chapter.lessons.map((l) => (
                  <section key={l.id} id={l.id} className="scroll-mt-24">
                    <header className="mb-3">
                      <h2 className="text-2xl font-semibold">{l.title}</h2>
                      {l.summary && (
                        <p
                          className={`mt-1 ${
                            theme === "dark" ? "text-neutral-300" : "text-neutral-600"
                          }`}
                        >
                          {l.summary}
                        </p>
                      )}
                    </header>

                    <div className="prose max-w-none space-y-4">
                      {l.content.map((node, idx) => {
                        if (node.type === "p") {
                          return <p key={idx}>{node.text}</p>;
                        }

                        if (node.type === "ul") {
                          return (
                            <ul key={idx} className="list-disc pl-5 space-y-1">
                              {node.items.map((it, i) => (
                                <li key={i}>{it}</li>
                              ))}
                            </ul>
                          );
                        }

                        if (node.type === "code") {
                          return (
                            <CodeBlock
                              key={idx}
                              code={node.code}
                              lang={node.lang}
                              filename={node.filename}
                              appearance={theme}  // 跟随主题
                            />
                          );
                        }

                        // ✅ 新增：图片节点渲染（用 next/image）
                        if (node.type === "img") {
                          const width = node.width ?? 1200;
                          const height = node.height ?? 800;
                          return (
                            <figure key={idx} className="my-6">
                              <Image
                                src={node.src}
                                alt={node.alt}
                                width={width}
                                height={height}
                                className="rounded-md border border-neutral-200"
                                priority={false}
                              />
                              {node.caption && (
                                <figcaption className="mt-2 text-sm text-neutral-600">
                                  {node.caption}
                                </figcaption>
                              )}
                            </figure>
                          );
                        }

                        return null;
                      })}
                    </div>

                  </section>
                ))}
              </div>
            ))}
          </article>
        </section>
      </main>
    </div>
  );
}